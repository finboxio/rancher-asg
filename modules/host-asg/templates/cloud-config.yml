#cloud-config
write_files:
  - path: /etc/profile.d/alias.sh
    permissions: "0755"
    owner: root
    content: |
      alias serf="sudo system-docker exec -it serf serf"
      alias curl="sudo system-docker exec -it serf curl"
      alias rocker="sudo system-docker"
      alias update="sudo system-docker pull finboxio/rancher-aws-host:${version}"
rancher:
  environment:
    TAG_DEPLOYMENT_ID: ${lower(deployment_id)}
    TAG_DEPLOYMENT_ENVIRONMENT: ${lower(environment_name)}
    TAG_DEPLOYMENT_GROUP: ${lower(environment_group)}
    RANCHER_HOSTNAME: ${rancher_hostname}
    RANCHER_SCHEME: https
    SQS_URL: ${shudder_sqs_url}
    CREDENTIALS_FILE: s3://${s3_bucket}/credentials
    TOKEN_FILE: s3://${s3_bucket}/${environment_name}.token
    ENVIRONMENT_NAME: ${environment_name}
    ENVIRONMENT_TYPE: ${environment_type}
    TERMINATOR_PORT: 2489
    HEALTHCHECK_PORT: 2490
    SLACK_WEBHOOK_URL: ${slack_webhook}
    SLACK_USERNAME: Rancher
    SLACK_ICON: cow
  services:
    docker-monitor:
      image: finboxio/rancher-aws-host:${version}
      entrypoint: [ "docker-monitor" ]
      restart: on-failure
      labels:
        - io.rancher.os.scope=system
        - io.rancher.os.after=docker
        - io.rancher.os.detach=false
      volumes:
        - /var/run:/var/run
        - /usr/bin/system-docker:/usr/bin/system-docker
        - /usr/bin/docker:/usr/bin/docker
    tag:
      image: finboxio/rancher-aws-host:${version}
      entrypoint: [ "tag-instance" ]
      restart: on-failure
      net: host
      labels:
        - io.rancher.os.scope=system
        - io.rancher.os.detach=false
      environment:
        - TAG_*
    serf:
      image: finboxio/rancher-aws-host:${version}
      entrypoint: [ "serf-bootstrap" ]
      restart: always
      net: host
      labels:
        - io.rancher.os.scope=system
        - io.rancher.os.after=tag
      environment:
        - TAG_*
      volumes:
        - /etc/serf:/etc/serf
    shudder:
      image: finboxio/rancher-aws-host:${version}
      entrypoint: [ 'shudder-bootstrap' ]
      restart: on-failure
      net: host
      labels:
        - io.rancher.os.scope=system
      environment:
        - SLACK_*
        - SQS_URL
        - TERMINATOR_PORT
        - TAG_DEPLOYMENT_ID
    terminator:
      image: finboxio/rancher-aws-host:${version}
      entrypoint: [ 'terminator-bootstrap' ]
      restart: on-failure
      net: host
      tty: true
      labels:
        - io.rancher.os.scope=system
      environment:
        - SLACK_*
        - RANCHER_*
        - CREDENTIALS_FILE
        - TOKEN_FILE
        - TERMINATOR_PORT
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - /usr/bin/docker:/usr/bin/docker
    healthcheck:
      image: finboxio/rancher-aws-host:${version}
      entrypoint: [ 'healthcheck-bootstrap' ]
      restart: on-failure
      net: host
      tty: true
      labels:
        - io.rancher.os.scope=system
      environment:
        - SLACK_*
        - RANCHER_*
        - ENVIRONMENT_*
        - HEALTHCHECK_PORT
        - CREDENTIALS_FILE
        - TOKEN_FILE
    register:
      image: finboxio/rancher-aws-host:${version}
      entrypoint: [ 'rancher-bootstrap' ]
      restart: on-failure
      net: host
      labels:
        - io.rancher.os.scope=system
        - io.rancher.os.after=tag
      environment:
        - TAG_*
        - SLACK_*
        - RANCHER_*
        - CREDENTIALS_FILE
        - TOKEN_FILE
        - ENVIRONMENT_*
      volumes:
        - /var/run:/var/run
        - /usr/bin/system-docker:/usr/bin/system-docker
        - /usr/bin/docker:/usr/bin/docker
        - /var/lib/rancher:/var/lib/rancher
